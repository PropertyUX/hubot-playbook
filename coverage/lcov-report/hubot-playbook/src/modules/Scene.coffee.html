<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for hubot-playbook/src/modules/Scene.coffee</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">all files</a> / <a href="index.html">hubot-playbook/src/modules/</a> Scene.coffee
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>95/95</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">96% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>24/25</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>16/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>62/62</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">114×</span>
<span class="cline-any cline-yes">114×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">158×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">158×</span>
<span class="cline-any cline-yes">158×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">158×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">143×</span>
<span class="cline-any cline-yes">143×</span>
<span class="cline-any cline-yes">158×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">262×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">169×</span>
<span class="cline-any cline-yes">65×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">75×</span>
<span class="cline-any cline-yes">75×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-yes">74×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">93×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">_ = require 'lodash'
Base = require './Base'
Dialogue = require './Dialogue'
&nbsp;
###*
 * Handle array of participants engaged in dialogue with bot
 * Credit to lmarkus/hubot-conversation for the original concept
 * Engaged bot will ignore global listeners, only respond to dialogue choices
 * - entering a user scene will engage the user
 * - entering a room scene will engage the whole room
 * - entering a direct scene will engage the user in that room only
 * @param  {Robot}  robot  - Hubot Robot instance
 * @param  {String} [type] - Type of scene: user(default)|room|direct
 * @param  {Object} [opts] - For dialogue config, e.g set reply method
###
class Scene extends Base
  constructor: (robot, args...) -&gt;
    @type = if _.isString args[0] then args.shift() else 'user'
    @error "invalid scene type" if @type not in [ 'room', 'user', 'direct' ]
&nbsp;
    super 'scene', robot, args...
    @Dialogue = Dialogue
    @engaged = {}
&nbsp;
    # override default for room type only if not explicitly set
    @config.sendReplies ?= true if @type is 'room'
&nbsp;
    # attach middleware
    @robot.receiveMiddleware (c, n, d) =&gt; @middleware.call @, c, n, d
&nbsp;
  ###*
   * Process incoming messages, re-route to dialogue for engaged participants
   * @param  {Object}   context - Passed through the middleware stack, with res
   * @param  {Function} next    - Called when all middleware is complete
   * @param  {Function} done    - Initial (final) completion callback
  ###
  middleware: (context, next, done) -&gt;
    res = context.response
    participants = @whoSpeaks res
&nbsp;
    # are incoming messages from this scenes' engaged participants
    if participants of @engaged
      @log.debug "#{ participants } is engaged, routing dialogue."
      res.finish() # don't process regular listeners
      @engaged[participants].receive res # let dialogue handle the response
      done() # don't process further middleware.
    else
      @log.debug "#{ participants } not engaged, continue as normal."
      next done
    return
&nbsp;
  ###*
   * Add listener with callback to enter scene
   * @param  {String} type       - The listener type: hear|respond
   * @param  {RegExp} regex      - Matcher for listener
   * @param  {Function} callback - Callback to fire when matched
  ###
  listen: (type, regex, callback) -&gt;
    @error "Invalid listener type" if type not in ['hear', 'respond']
    @error "Invalid regex for listener" if not _.isRegExp regex
    @error "Invalid callback for listener" if not _.isFunction callback
&nbsp;
    # setup listener with scene as attribute for later/external reference
    @robot[type] regex, id: @id, scene: @, (res) =&gt;
      dialogue = @enter res # may fail if enter hooks override (from Director)
      <span class="missing-if-branch" title="else path not taken" >E</span>callback res, dialogue if dialogue?
    return
&nbsp;
  ###*
   * Alias of .listen with hear as specified type
  ###
  hear: (args...) -&gt; return @listen 'hear', args...
&nbsp;
  ###*
   * Alias of .listen with respond as specified type
  ###
  respond: (args...) -&gt; return @listen 'respond', args...
&nbsp;
  ###*
   * Identify the source of a message relative to the scene type
   * @param  {Response} res - Hubot Response object
   * @return {String}       - ID of room, user or composite
  ###
  whoSpeaks: (res) -&gt;
    return switch @type
      when 'room' then return res.message.room.toString()
      when 'user' then return res.message.user.id.toString()
      when 'direct' then return "#{ res.message.user.id }_#{ res.message.room }"
&nbsp;
  ###*
   * Engage the participants in dialogue
   * @param  {Response} res  - Hubot Response object
   * @param  {Object} [opts] - Options for dialogue, merged with scene config
   * @return {Dialogue}      - The started dialogue
  ###
  enter: (res, opts={}) -&gt;
    participants = @whoSpeaks res
    return if @inDialogue participants
    dialogue = new @Dialogue res, _.defaults @config, opts
    dialogue.on 'timeout', (dlg, res) =&gt;
      @exit res, 'timeout'
    dialogue.on 'end', (dlg, res) =&gt;
      @exit res, "#{ if dlg.path?.closed then '' else 'in' }complete"
    @engaged[participants] = dialogue
    @emit 'enter', res, dialogue
    @log.info "Engaging #{ @type } #{ participants } in dialogue"
    return dialogue
&nbsp;
  ###*
   * Disengage participants from dialogue e.g. in case of timeout or error
   * @param  {Response} res    - Hubot
   * @param  {String} [status] - Some context, for logs
   * @return {Boolean}         - Exit success (may fail if already disengaged)
  ###
  exit: (res, status) -&gt;
    status ?= 'unknown'
    participants = @whoSpeaks res
    if @engaged[participants]?
      @engaged[participants].clearTimeout()
      delete @engaged[participants]
      @emit 'exit', res, status
      @log.info "Disengaged #{ @type } #{ participants } (#{ status })"
      return true
    @log.debug "Cannot disengage #{ participants }, not in #{ @type } scene"
    return false
&nbsp;
  ###*
   * End all engaged dialogues
  ###
  exitAll: -&gt;
    @log.info "Disengaging all in #{ @type } scene"
    _.invokeMap @engaged, 'clearTimeout'
    @engaged = []
    return
&nbsp;
  ###*
   * Get the dialogue for engaged participants (relative to scene type)
   * @param  {String} participants - ID of user, room or composite
   * @return {Dialogue}            - Engaged dialogue instance
  ###
  getDialogue: (participants) -&gt;
    return @engaged[participants]
&nbsp;
  # return the engaged status for an participants
  ###*
   * Get the engaged status for participants
   * @param  {String} participants - ID of user, room or composite
   * @return {Boolean}             - Is engaged status
  ###
  inDialogue: (participants) -&gt;
    return participants in _.keys @engaged
&nbsp;
module.exports = Scene
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue May 09 2017 00:04:30 GMT+1000 (AEST)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
