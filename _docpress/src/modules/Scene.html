<!DOCTYPE html>

<html>
<head>
  <title>Scene.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>Scene.coffee</h1>
        

        
      </div>

      
        
        <p>credit to lmarkus/hubot-conversation for the original concept</p>

        
          <div class='highlight'><pre>_ = <span class="hljs-built_in">require</span> <span class="hljs-string">'underscore'</span>
{inspect} = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>

Dialogue = <span class="hljs-built_in">require</span> <span class="hljs-string">'./Dialogue'</span>
Helpers = <span class="hljs-built_in">require</span> <span class="hljs-string">'./Helpers'</span></pre></div>
        
      
        
        <p>handles array of participants engaged in dialogue
while engaged the robot will only follow the given dialogue choices
entering a user scene will engage the user
entering a room scene will engage the whole room
entering a direct scene will engage the user in that room only</p>

        
          <div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Scene</span></span></pre></div>
        
      
        
        <p>@param robot {Object} a hubot instance
@param type (optional) {String} room, user (default) or direct
@param opts (optional) {Object} for dialogue config, e.g set reply method</p>

        
          <div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-params">(@robot, args...)</span> -&gt;</span></pre></div>
        
      
        
        <p>take arguments in param order, for all optional arguments</p>

        
          <div class='highlight'><pre>    @type = <span class="hljs-keyword">if</span> _.isString args[<span class="hljs-number">0</span>] <span class="hljs-keyword">then</span> args.shift() <span class="hljs-keyword">else</span> <span class="hljs-string">'user'</span>
    opts = <span class="hljs-keyword">if</span> _.isObject args[<span class="hljs-number">0</span>] <span class="hljs-keyword">then</span> args.shift() <span class="hljs-keyword">else</span> {}

    <span class="hljs-keyword">if</span> @type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [ <span class="hljs-string">'room'</span>, <span class="hljs-string">'user'</span>, <span class="hljs-string">'direct'</span> ]
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"invalid scene type given"</span></pre></div>
        
      
        
        <p>create an id using scene scope (and key if given)</p>

        
          <div class='highlight'><pre>    @id = Helpers.keygen <span class="hljs-string">'scene'</span>, opts.key <span class="hljs-keyword">or</span> <span class="hljs-literal">undefined</span></pre></div>
        
      
        
        <p>‘@user hello’ vs ‘hello’</p>

        
          <div class='highlight'><pre>    sendReplies = <span class="hljs-keyword">if</span> @type <span class="hljs-keyword">is</span> <span class="hljs-string">'room'</span> <span class="hljs-keyword">then</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span></pre></div>
        
      
        
        <p>extend options with defaults (or env vars) (passed to dialogue)</p>

        
          <div class='highlight'><pre>    @config = _.defaults opts,
      sendReplies: process.env.SEND_REPLIES <span class="hljs-keyword">or</span> sendReplies</pre></div>
        
      
        
        <p>cast send config as proper bool in case string came from environment var</p>

        
          <div class='highlight'><pre>    @config.sendReplies = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> @config.sendReplies <span class="hljs-keyword">in</span> [<span class="hljs-string">'true'</span>, <span class="hljs-string">'TRUE'</span>]
    @config.sendReplies = <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> @config.sendReplies <span class="hljs-keyword">in</span> [<span class="hljs-string">'false'</span>, <span class="hljs-string">'FALSE'</span>]

    @engaged = {} <span class="hljs-comment"># dialogues of each engaged participant type</span>
    @log = @robot.logger <span class="hljs-comment"># shorthand helper</span></pre></div>
        
      
        
        <p>attach middleware</p>

        
          <div class='highlight'><pre>    @robot.receiveMiddleware (c, n, d) =&gt; @middleware.call @, c, n, d</pre></div>
        
      
        
        <p>process all incoming messages, re-route to dialogue for engaged participants</p>

        
          <div class='highlight'><pre>  middleware: <span class="hljs-function"><span class="hljs-params">(context, next, done)</span> -&gt;</span>
    res = context.response
    participants = @whoSpeaks res</pre></div>
        
      
        
        <p>are incoming messages from this scenes’ engaged participants</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> participants <span class="hljs-keyword">of</span> @engaged
      @log.debug <span class="hljs-string">"<span class="hljs-subst">#{ participants }</span> is engaged, routing dialogue."</span>
      res.finish() <span class="hljs-comment"># don't process regular listeners</span>
      @engaged[participants].receive res <span class="hljs-comment"># let dialogue handle the response</span>
      done() <span class="hljs-comment"># don't process further middleware.</span>
    <span class="hljs-keyword">else</span>
      @log.debug <span class="hljs-string">"<span class="hljs-subst">#{ participants }</span> not engaged, continue as normal."</span>
      next done
    <span class="hljs-keyword">return</span></pre></div>
        
      
        
        <p>setup listener callback to enter scene
@param type - the listener type, should be hear or respond
@param</p>

        
          <div class='highlight'><pre>  listen: <span class="hljs-function"><span class="hljs-params">(type, args...)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Invalid listener type"</span> <span class="hljs-keyword">if</span> type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-string">'hear'</span>,<span class="hljs-string">'respond'</span>]</pre></div>
        
      
        
        <p>valid regex as first arg (required)</p>

        
          <div class='highlight'><pre>    regex = args.shift()
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Invalid regex for listener"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _.isRegExp regex</pre></div>
        
      
        
        <p>create id from scene namespace and listener scope (and key if provided)</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> _.isString args[<span class="hljs-number">0</span>]
      id = Helpers.keygen @id+<span class="hljs-string">'_listener'</span>, args.shift()
    <span class="hljs-keyword">else</span>
      id = Helpers.keygen @id+<span class="hljs-string">'_listener'</span></pre></div>
        
      
        
        <p>last arg taken as callback (required)</p>

        
          <div class='highlight'><pre>    callback = args.shift()
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Invalid callback for listener"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _.isFunction callback</pre></div>
        
      
        
        <p>setup robot listener with given or generated key, so it can be referred to</p>

        
          <div class='highlight'><pre>    @robot[type] regex, id: id, <span class="hljs-function"><span class="hljs-params">(res)</span> =&gt;</span>
      dialogue = @enter res <span class="hljs-comment"># may fail if enter hooks override (from Director)</span>
      callback.call dialogue, res <span class="hljs-keyword">if</span> dialogue? <span class="hljs-comment"># in callback dialogue is 'this'</span>

    <span class="hljs-keyword">return</span> id</pre></div>
        
      
        
        <p>alias of .listen with hear as specified type</p>

        
          <div class='highlight'><pre>  hear: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span> <span class="hljs-keyword">return</span> @listen <span class="hljs-string">'hear'</span>, args...</pre></div>
        
      
        
        <p>alias of .listen with respond as specified type</p>

        
          <div class='highlight'><pre>  respond: <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span> <span class="hljs-keyword">return</span> @listen <span class="hljs-string">'respond'</span>, args...</pre></div>
        
      
        
        <p>return the source of a message (ID of user or room)</p>

        
          <div class='highlight'><pre>  whoSpeaks: <span class="hljs-function"><span class="hljs-params">(res)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> @type
      <span class="hljs-keyword">when</span> <span class="hljs-string">'room'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> res.message.room
      <span class="hljs-keyword">when</span> <span class="hljs-string">'user'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> res.message.user.id
      <span class="hljs-keyword">when</span> <span class="hljs-string">'direct'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"<span class="hljs-subst">#{res.message.user.id}</span>_<span class="hljs-subst">#{res.message.room}</span>"</span></pre></div>
        
      
        
        <p>engage the participants in dialogue
@param res, the response object
@param opts (optional), key/vals for dialogue config, e.g overide timeout</p>

        
          <div class='highlight'><pre>  enter: <span class="hljs-function"><span class="hljs-params">(res, opts={})</span> -&gt;</span></pre></div>
        
      
        
        <p>extend dialogue options with scene config</p>

        
          <div class='highlight'><pre>    opts = _.defaults @config, opts</pre></div>
        
      
        
        <p>setup dialogue to handle choices for response branching</p>

        
          <div class='highlight'><pre>    participants = @whoSpeaks res
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">if</span> @inDialogue participants
    @log.info <span class="hljs-string">"Engaging <span class="hljs-subst">#{ @type }</span> <span class="hljs-subst">#{ participants }</span> in dialogue"</span>
    @engaged[participants] = <span class="hljs-keyword">new</span> Dialogue res, opts</pre></div>
        
      
        
        <p>remove participants from engaged participants on timeout or completion</p>

        
          <div class='highlight'><pre>    @engaged[participants].<span class="hljs-literal">on</span> <span class="hljs-string">'timeout'</span>, <span class="hljs-function">=&gt;</span> @exit res, <span class="hljs-string">'timeout'</span>
    @engaged[participants].<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-params">(completed)</span> =&gt;</span>
      @exit res, <span class="hljs-string">"<span class="hljs-subst">#{ <span class="hljs-keyword">if</span> completed <span class="hljs-keyword">then</span> <span class="hljs-string">'complete'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'incomplete'</span> }</span>"</span>
    <span class="hljs-keyword">return</span> @engaged[participants] <span class="hljs-comment"># return started dialogue</span></pre></div>
        
      
        
        <p>disengage an participants from dialogue (can help in case of error)</p>

        
          <div class='highlight'><pre>  exit: <span class="hljs-function"><span class="hljs-params">(res, reason=<span class="hljs-string">'unknown'</span>)</span> -&gt;</span>
    participants = @whoSpeaks res
    <span class="hljs-keyword">if</span> @engaged[participants]?
      @log.info <span class="hljs-string">"Disengaging <span class="hljs-subst">#{ @type }</span> <span class="hljs-subst">#{ participants }</span> because <span class="hljs-subst">#{ reason }</span>"</span>
      @engaged[participants].clearTimeout()
      <span class="hljs-keyword">delete</span> @engaged[participants]
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div>
        
      
        
        <p>user may have been already removed by timeout event before end:incomplete</p>

        
          <div class='highlight'><pre>    @log.debug <span class="hljs-string">"Cannot disengage <span class="hljs-subst">#{ participants }</span>, not in <span class="hljs-subst">#{ @type }</span> scene"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div>
        
      
        
        <p>end all engaged dialogues</p>

        
          <div class='highlight'><pre>  exitAll: <span class="hljs-function">-&gt;</span>
    @log.info <span class="hljs-string">"Disengaging all in <span class="hljs-subst">#{ @type }</span> scene"</span>
    _.invoke @engaged, <span class="hljs-string">'clearTimeout'</span>
    @engaged = []
    <span class="hljs-keyword">return</span></pre></div>
        
      
        
        <p>return the dialogue for an engaged participants</p>

        
          <div class='highlight'><pre>  dialogue: <span class="hljs-function"><span class="hljs-params">(participants)</span> -&gt;</span> <span class="hljs-keyword">return</span> @engaged[participants] <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span></pre></div>
        
      
        
        <p>return the engaged status for an participants</p>

        
          <div class='highlight'><pre>  inDialogue: <span class="hljs-function"><span class="hljs-params">(participants)</span> -&gt;</span> <span class="hljs-keyword">return</span> participants <span class="hljs-keyword">in</span> _.keys @engaged

<span class="hljs-built_in">module</span>.exports = Scene</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
